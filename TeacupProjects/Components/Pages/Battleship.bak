@page "/battleship"
@page "/battleship/{id}"
@rendermode InteractiveServer
@using TeacupProjects.Battleship.Signal
@using TeacupProjects.Battleship
@inject NavigationManager NavigationManager
@inject IBattleshipClient BattleshipClient

<h3>Battleship</h3>
@if (string.IsNullOrEmpty(Id))
{
    <button class="btn btn-primary" @onclick="StartGame">Start Game</button>
}
else if (!_isConnected)
{
    <p>Loading...</p>
}
else
{
    <p>Id: @Id</p>
    <p>Url: <a href="@NavigationManager.Uri">@NavigationManager.Uri</a></p>
    
    <p>
        <label>Username</label>
        <input type="text" @bind="@PendingName" @bind:event="oninput"/>
        @if (_nameChanged)
        {
            <button @onclick="ChangeName">Change Name</button>
        }
    </p>
    
    <div>
        <label>Send Message</label>
        <div>
            <textarea rows="2" @bind="@PendingMessage"></textarea>
        </div>
        <div>
            <button @onclick="Send" disabled="@(!BattleshipClient.IsConnected)">Send</button>
        </div>
    </div>
    
    <table>
        <thead>
        <tr>
            <th>Player</th>
            <th>Ready</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>@(string.IsNullOrEmpty(_myName) ? _myId : _myName)</td>
            <td>@_isReady</td>
        </tr>
        @foreach (var player in _otherPlayers)
        {
            <tr>
                <td>@(string.IsNullOrEmpty(player.Value.name) ? player.Key : player.Value.name)</td>
                <td>@player.Value.isReady</td>
            </tr>
        }
        </tbody>
    </table>
    
    <p>Connected: @BattleshipClient.IsConnected</p>
    <ul>
        @foreach (var message in _messages)
        {
            <li>@message</li>
        }
    </ul>
    
    <p role="status">@_isReady</p>
    
    <!-- my board -->
    <table>
        @for (var i = 0; i < 10; i++)
        {
            var y = i;
            <tr>
                @for (var j = 0; j < 10; j++)
                {
                    var x = j;
                    <td class="@_myBoard?.cells[x,y].Classes"
                        @onmousedown="e => OnMouseDownMyBoard(e, (x,y))"
                        @onmouseover='e => OnMouseOverMyBoard(e, (x,y))'
                        @onmouseout='e => OnMouseOffMyBoard(e, (x,y))'
                        @oncontextmenu='_ => { }'
                        @oncontextmenu:preventDefault="true">?</td>
                }
            </tr>
        }
    </table>
    <p role="status">@_status</p>
}


@code {
    [Parameter]
    public string? Id { get; set; }
    
    // is connected
    private bool _isConnected;

    // my unique ID
    private readonly string _myId = Guid.NewGuid().ToString();
    // my player name
    private string? _myName;

    private string? _pendingName;
    private string PendingName
    {
        get => _pendingName ?? String.Empty;
        set
        {
            if (_pendingName == value)
                return;
            _pendingName = value;
            _nameChanged = !string.IsNullOrWhiteSpace(_pendingName) && !_pendingName.Equals(_myName);
        } 
    }
    private bool _nameChanged;
    
    // message
    private string? _pendingMessage;
    private string PendingMessage
    {
        get => _pendingMessage ?? string.Empty;
        set => _pendingMessage = value;
    }
    
    // other players
    private readonly Dictionary<string, Player> _otherPlayers = new();
    
    // ready
    private bool _isReady;
    
    private readonly List<string> _messages = [];
    private readonly Board _myBoard = new();
    private readonly List<Ship> _shipsToPlace =
    [
        new Ship.Carrier(),
        new Ship.Battleship(),
        new Ship.Cruiser(),
        new Ship.Submarine(),
        new Ship.Destroyer()
    ];

    private string _status = string.Empty;
    
    private void StartGame()
    {
        NavigationManager.NavigateTo($"/battleship/{Guid.NewGuid()}", true);
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (!string.IsNullOrEmpty(Id))
            {
                BattleshipClient.OnPlayerJoined(OnPlayerJoined);
                BattleshipClient.OnPlayerWelcomed(OnPlayerWelcomed);
                BattleshipClient.OnPlayerChangedName(OnPlayerChangedName);
                BattleshipClient.OnMessageReceived(OnMessageReceived);
                BattleshipClient.OnPlayerReady(OnPlayerReady);

                await BattleshipClient.Start();
                await BattleshipClient.JoinRoom(Id, _myId);
            }
            _isConnected = true;
            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Id))
        {
            BattleshipClient.OnPlayerJoined(OnPlayerJoined);
            BattleshipClient.OnPlayerWelcomed(OnPlayerWelcomed);
            BattleshipClient.OnPlayerChangedName(OnPlayerChangedName);
            BattleshipClient.OnMessageReceived(OnMessageReceived);
            BattleshipClient.OnPlayerReady(OnPlayerReady);

            await BattleshipClient.Start();
            await BattleshipClient.JoinRoom(Id, _myId);
        }
    }

    private async Task ChangeName()
    {
        if (string.IsNullOrWhiteSpace(PendingName) || PendingName.Equals(_myName))
            return;
        
        _myName = PendingName;
        await BattleshipClient.DeclareName(Id, _myId, _myName);
        _nameChanged = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task Send()
    {
        if (!string.IsNullOrWhiteSpace(PendingMessage))
        {
            _messages.Add(string.IsNullOrWhiteSpace(_myName) 
                ? $"[{_myId}] {PendingMessage}"
                : $"[{_myName}] {PendingMessage}");
            await BattleshipClient.BroadcastMessage(Id, _myId, PendingMessage);
            PendingMessage = string.Empty;
        }
    } 

    private async Task OnMessageReceived(string roomId, string from, string message)
    {
        _otherPlayers.TryGetValue(from, out var player);
        _messages.Add(
            string.IsNullOrEmpty(player?.name)
            ? $"[{from}]: {message}" 
            : $"[{player.name}]: {message}");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPlayerJoined(string roomId, string incomingId)
    {
        if (_myId.Equals(incomingId))
            return;
        
        if (!_otherPlayers.ContainsKey(incomingId))
        {
            _otherPlayers.TryAdd(incomingId, new Player { id = incomingId });
            _messages.Add($"Player {incomingId} joined.");
        }

        await BattleshipClient.WelcomePlayer(Id, _myId, _myName);
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPlayerWelcomed(string roomId, string incomingId, string? incomingName)
    {
        if (_otherPlayers.TryAdd(incomingId, new Player { name = incomingName }))
        {
            _messages.Add($"{incomingName ?? "Player"} [{incomingId}] welcomed you.");
        }
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task OnPlayerChangedName(string roomId, string incomingId, string incomingName)
    {
        _otherPlayers.TryGetValue(incomingId, out var player);
        var oldName = player?.name;
        _otherPlayers[incomingId].name = incomingName;
        _messages.Add($"{oldName ?? "Player"} [{incomingId}] changed their name to {incomingName}");
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task OnPlayerReady(string roomId, string playerId)
    {
        _otherPlayers.TryGetValue(playerId, out var player);
        if (player != null)
        {
            player.isReady = true;
            _messages.Add($"{NameOrPlayerWithId(playerId)} is ready.");
        }
        else if (_myId.Equals(playerId))
        {
            _messages.Add($"I am ready");
        }
        else
        {
            _messages.Add($"[OnPlayerReady] No player with id {playerId}");
            return;
        }

        if (_otherPlayers.Count(p => p.Value.isReady) + (_isReady ? 1 : 0) > 1)
        {
            // start countdown
        }
        await InvokeAsync(StateHasChanged);
    }

    private string NameOrId(Player player) => string.IsNullOrEmpty(player.name) ? player.id : player.name;

    private string NameOrPlayerWithId(string id)
    {
        _otherPlayers.TryGetValue(id, out var player);
        return string.IsNullOrEmpty(player?.name) ? $"Player [{id}]" : $"{player.name} [{id}]";
    }
    
    private void OnMouseOverMyBoard(MouseEventArgs _, (int x, int y) coords)
    {
        if (!_shipsToPlace.Any()) return;
        
        var cell = _myBoard.cells[coords.x, coords.y];
        _shipsToPlace.First().CanPlace(cell);
        _status = $"({coords.x}, {coords.y})";
    }
    
    private async Task OnMouseOffMyBoard(MouseEventArgs _, (int x, int y) coords)
    {
        if (_isReady)
            return;
        
        if (!_shipsToPlace.Any())
        {
            await DeclareReady();
            return;
        }
        
        var cell = _myBoard.cells[coords.x, coords.y];
        cell.ClearPlacementIndicator();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DeclareReady()
    {
        _isReady = true;
        await BattleshipClient.DeclareReady(Id, _myId);
        await InvokeAsync(StateHasChanged);
    }

    private void OnMouseDownMyBoard(MouseEventArgs obj, (int x, int y) coords)
    {
        if (_shipsToPlace.Any())
        {
            var ship = _shipsToPlace.First();
            if (obj.Button == 0)
            {
                var cell = _myBoard.cells[coords.x, coords.y];
                if (ship.TryPlace(cell))
                {
                    _shipsToPlace.RemoveAt(0);
                }
            } 
            else if (obj.Button == 2)
            {
                ship.ToggleOrientation();
            }
        }
    }
}